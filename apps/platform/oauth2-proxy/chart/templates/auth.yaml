apiVersion: onepassword.com/v1
kind: OnePasswordItem
metadata:
  name: oauth2-proxy-secret
  namespace: traefik
spec:
  itemPath: "{{ .Values.onepassword.itemPath }}"
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: oauth2-proxy-auth
  namespace: traefik
spec:
  forwardAuth:
    address: http://oauth2-proxy.traefik.svc.cluster.local:4180/oauth2/auth
    trustForwardHeader: true
    authResponseHeaders:
      - X-Auth-Request-User
      - X-Auth-Request-Email
      - X-Auth-Request-Groups
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: oauth2-proxy
  namespace: traefik
spec:
  entryPoints:
  - websecure
  routes:
  - kind: Rule
    match: Host(`{{ .Values.traefik.host }}`)
    services:
    - name: oauth2-proxy
      namespace: traefik
      port: 80
  tls:
    secretName: {{ .Values.traefik.tlsSecret }}
