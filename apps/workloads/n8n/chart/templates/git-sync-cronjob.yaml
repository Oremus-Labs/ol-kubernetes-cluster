{{- if .Values.gitSync.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "n8n.fullname" . }}-sync
  labels:
    {{- include "n8n.commonLabels" . | nindent 4 }}
spec:
  schedule: {{ .Values.gitSync.schedule | quote }}
  successfulJobsHistoryLimit: {{ .Values.gitSync.history.successful | default 1 }}
  failedJobsHistoryLimit: {{ .Values.gitSync.history.failed | default 3 }}
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          initContainers:
            - name: git-sync
              image: {{ .Values.gitSync.gitSyncImage | quote }}
              env:
                - name: GIT_SYNC_REPO
                  value: {{ .Values.gitSync.repo | quote }}
                - name: GIT_SYNC_BRANCH
                  value: {{ .Values.gitSync.branch | quote }}
                - name: GIT_SYNC_ROOT
                  value: /workdir
                - name: GIT_SYNC_DEST
                  value: repo
                - name: GIT_SYNC_ONE_TIME
                  value: "true"
              {{- if .Values.gitSync.gitSecret.name }}
                - name: GIT_SYNC_SSH
                  value: "true"
                - name: GIT_SSH_KEY_FILE
                  value: /etc/git-secret/{{ .Values.gitSync.gitSecret.sshKey | default "id_ed25519" }}
                - name: GIT_KNOWN_HOSTS
                  value: "true"
                - name: GIT_KNOWN_HOSTS_FILE
                  value: /etc/git-secret/{{ .Values.gitSync.gitSecret.knownHosts | default "known_hosts" }}
              {{- end }}
              volumeMounts:
                - name: repo
                  mountPath: /workdir
              {{- if .Values.gitSync.gitSecret.name }}
                - name: git-secret
                  mountPath: /etc/git-secret
                  readOnly: true
              {{- end }}
          containers:
            - name: sync-runner
              image: {{ .Values.gitSync.runnerImage | quote }}
              imagePullPolicy: IfNotPresent
              env:
                - name: N8N_API_URL
                  value: {{ .Values.gitSync.apiUrl | quote }}
                - name: N8N_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.gitSync.apiSecret.name | quote }}
                      key: {{ .Values.gitSync.apiSecret.key | quote }}
              {{- with .Values.gitSync.pushRef }}
                - name: N8N_PUSH_REF
                  value: {{ . | quote }}
              {{- end }}
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  cd /workdir/repo
                  npm ci --omit=dev --ignore-scripts
                  npm run import
              volumeMounts:
                - name: repo
                  mountPath: /workdir
              {{- with .Values.gitSync.resources }}
              resources:
                {{- toYaml . | nindent 16 }}
              {{- end }}
          volumes:
            - name: repo
              emptyDir: {}
            {{- if .Values.gitSync.gitSecret.name }}
            - name: git-secret
              secret:
                secretName: {{ .Values.gitSync.gitSecret.name | quote }}
                defaultMode: 0400
            {{- end }}
{{- end }}
